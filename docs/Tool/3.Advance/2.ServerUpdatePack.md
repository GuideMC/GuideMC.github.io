# 制作在线更新整合包

本章旨在为您提供一个从零开始、全面详尽的教程，教您如何创建、部署并维护一个可以进行在线自动更新的 Minecraft 整合包。  
无论是为您的服务器玩家提供便利，还是作为整合包作者向社区分发作品，掌握此项技能都将极大提升用户体验并简化您的更新流程。

**核心优势:**

- **玩家体验极佳**：玩家只需启动游戏，启动器便会自动检查并下载更新，无需手动操作。
- **作者维护高效**：告别“发新版-群里喊-玩家手动换”的原始模式，实现一键推送更新。
- **版本统一**：确保所有服务器玩家都使用完全一致的客户端，减少因版本不匹配导致的问题。

**开始之前，请确保您具备：**

1. **一个制作好的 Minecraft 客户端整合包**：包含您希望分发的所有 Mods、配置文件等。
2. **一个支持此功能的启动器**：本教程将以 **HMCL** 和 **BakaXL** 为例。
3. **一个文件托管方案**：用于存放整合包文件并能通过 HTTP(S) 链接公开访问。

:::danger 成本与流量警告！
整合包的分发与更新会产生网络流量。若使用按量计费的云服务（如对象存储），**请务必配合 CDN 并了解其计费规则**，否则在大量玩家下载时可能会产生意想不到的高昂费用！
:::

## 搭建您的文件服务器

整合包文件需要一个“家”，玩家的启动器通过这个“家”的地址来下载文件。这里有三种主流方案，请根据您的技术背景和需求选择其一。

### 手动配置 Nginx (适合有经验者)

此方案给予您完全的控制权，但需要您熟悉 Linux 命令行操作。

1. **安装 Nginx 并创建静态资源目录**：

    ```bash
    # 安装 Nginx
    sudo apt install nginx    # Debian/Ubuntu
    sudo yum install nginx    # CentOS/RHEL
    # 在根目录创建一个专用于存放整合包的文件夹
    sudo mkdir -p /var/www/minecraft
    # 赋予 Nginx 读取权限
    sudo chown -R www-data:www-data /var/www/minecraft # Debian/Ubuntu
    # sudo chown -R nginx:nginx /var/www/minecraft   # CentOS/RHEL
    sudo chmod -R 755 /var/www/minecraft
    ```

2. **配置 Nginx**：
    在 `/etc/nginx/sites-available/` 目录下创建一个新的配置文件，例如 `minecraft.conf`。  
    填入以下内容：

    ```nginx
    server {
        listen 80; # 监听 IPv4 的 80 端口
        listen [::]:80; # 监听 IPv6 的 80 端口
        server_name 你的服务器IP或域名; # 将此替换为你的公网 IP 或域名
        root /var/www/minecraft; # 指向你创建的静态资源目录
        location / {
            try_files $uri $uri/ =404; # 标准文件服务配置
            autoindex on; # [可选但推荐] 开启目录浏览，方便查看文件列表
        }
    }
    ```

    创建软链接以启用此站点：`sudo ln -s /etc/nginx/sites-available/minecraft.conf /etc/nginx/sites-enabled/`  
    测试并重载 Nginx 配置：`sudo nginx -t` 和 `sudo systemctl reload nginx`。

### 对象存储 + CDN (专业且推荐的方案)

这是最稳定、高效且具成本效益的方案，尤其适合面向大量玩家的整合包。

1. 在腾讯云 (COS)、阿里云 (OSS) 或其他云服务商处，开通**对象存储**服务。
2. 新建一个存储桶并设置为“**公开（公共）读**”，这是为了让玩家的启动器能匿名下载文件。
3. 在同一服务商处开通 **CDN** (内容分发网络) 服务，添加一个**加速域名**。  
   将源站类型设置为 **“对象存储”**，并选择您刚刚创建的那个存储桶。
4. 配置完成后，CDN 会提供给您一个加速域名，**这个域名就是您未来的文件托管地址**。

## 导出与配置

现在，使用启动器将您的本地客户端打包成可在线更新的格式。

1. **打开启动器并导出整合包**：右键点击您配置好的游戏版本，选择 `导出整合包`。
2. **选择类型**：选择 `服务器自动更新整合包`。对于 BakaXL，流程类似，选择 `核心导出向导`。
3. **填写核心信息**：
   - **整合包名称/ID**：为其取一个清晰的名称。
   - **整合包版本号**：这是更新机制的核心。推荐使用**语义化版本号**（Major.Minor.Patch，如 `1.0.0`）。每次更新时，您都必须提升此版本号（如 `1.0.1`）。
   - **整合包下载链接前缀 / 更新 API 根地址**：**这是最关键的一步！** 此处填写您之前准备好的 URL 地址，并指向一个计划用于存放该整合包的子目录。
     - **示例 (Nginx)**：若您计划在网站根目录下创建一个 `my-cool-pack` 文件夹来存放，则应填写 `http://你的服务器IP/my-cool-pack`。
     - **示例 (CDN)**：若您计划在存储桶中创建一个 `my-cool-pack` 文件夹，则应填写 `https://你的CDN加速域名/my-cool-pack`。
4. **选择文件并导出**：勾选所有您希望包含在整合包中的内容（`mods`, `config` 等文件夹），完成导出。您会得到一个 `.zip` 压缩文件。

## 上传部署

1. 根据您之前规划的 URL，在您的文件服务器上创建对应的文件夹。例如，若链接前缀是 `.../my-cool-pack`，请在您的网站根目录或存储桶中创建名为 `my-cool-pack` 的文件夹。
2. 将本地导出的那个 `.zip` 文件上传到这个新创建的 `my-cool-pack` 文件夹中。并**在服务器上直接解压**此 `.zip` 文件。解压后，该文件夹内应包含 `overrides` 文件夹和一个清单文件 (如 `server-manifest.json` 或 `mcbbs.packmeta`)。
3. 在浏览器中，尝试访问您的清单文件。例如，访问 `http://你的服务器IP/my-cool-pack/server-manifest.json`。如果能成功看到文件内容或浏览器提示下载，则代表部署成功。若出现 404 Not Found，请检查您的路径和文件名是否完全正确（Linux 区分大小写）。

## 分发整合包

**这是许多新手会出错的地方！** 您不能直接将导出的 `.zip` 文件发给玩家。正确的首次分发流程如下：

1. **创建纯净的启动环境**：在您的电脑上新建一个**空文件夹**，例如 `我的整合包-玩家版`。
2. **放入启动器**：将一个干净的启动器复制到这个空文件夹中。
3. **执行本地导入**：启动这个新的启动器，使用其 `导入整合包` 功能，选择您之前从本地导出的那个 `.zip` 文件。启动器会自动安装所有文件，并配置好在线更新地址。
4. **打包分发**：关闭启动器。将这**整个 `我的整合包-玩家版` 文件夹**压缩成一个新的 `.zip` 文件。
5. **这最后一个压缩包，才是您需要分发给玩家的最终文件！**

## 更新整合包

当您需要添加/删除 Mod 或修改配置时，按以下流程操作。

### 简单粗暴 - 完全重新导出

1. **本地修改**：在您自己的开发用客户端中完成所有文件修改。
2. **重新导出**：重复 **Part 2** 的流程，**务必将版本号提升**（如从 `1.0.0` 改为 `1.0.1`）。
3. **上传并覆盖**：将新导出的 `.zip` 文件上传到服务器上**相同的目录**，解压并**选择覆盖所有旧文件**。
4. **[关键] 刷新 CDN 缓存**：如果您使用了 CDN，**必须**前往 CDN 服务商的控制台，对被修改的文件（尤其是清单文件）进行**缓存刷新**。否则，玩家将无法检测到更新！

### 精准高效 - 手动编辑清单文件

当改动很小时，此方法更快捷。

1. **下载并修改文件**：将服务器上需要更新的文件（如某个 Mod）和清单文件 (`mcbbs.packmeta` / `server-manifest.json`) 下载到本地。用新文件替换旧文件。
2. **编辑清单文件**：  
   用文本编辑器（如 VS Code）打开清单文件。建议使用在线 JSON 格式化工具使其易于阅读。
   - **提升版本号**：找到 `version` 字段，将其值提高。
   - **修改 `files` 列表**：
     - **更新文件**：找到旧文件的条目，用新文件的 SHA1 哈希值替换旧的 `hash` 值。
     > （使用 `Get-FileHash '文件路径' -Algorithm SHA1` 命令获取，并确保为小写）。
     - **添加文件**：在 `files` 数组中新增一个对象，填入新文件的 `path` 和 `hash`。
     - **删除文件**：从 `files` 数组中删除该文件对应的整个对象。
   - **验证与压缩**：在 JSON 校验网站上验证您的修改无语法错误后，将其压缩成一行。
3. **上传**：将修改后的新文件和清单文件上传回服务器，覆盖旧版本。
4. **刷新 CDN 缓存**：同样，如果您使用了 CDN，**必须**前往 CDN 服务商的控制台，对被修改的文件（尤其是清单文件）进行**缓存刷新**，别忘了这一步。

## 疑难解答

| 常见问题 | 可能原因与解决方案 |
| :--- | :--- |
| **玩家无法检测到更新** | 1. **CDN 缓存未刷新 (最常见)**：登录 CDN 控制台，刷新清单文件的 URL。2. **版本号未更改**：确认新上传的清单文件中 `version` 字段已高于旧版本。3. **清单文件 URL 错误**：在浏览器中直接访问清单文件 URL，检查是否 404 或 403。 |
| **文件下载失败 (404)** | 1. **路径不匹配**：清单文件中的 `path` 与服务器上的实际文件结构**必须完全一致**，包括大小写。2. **链接前缀错误**：检查导出时填写的 URL 前缀是否正确。3. **文件权限问题**：若自建服务器，确保 Nginx 用户有权限读取文件。 |
| **JSON 格式或解析错误** | 检查清单文件是否存在语法错误，如**多余的逗号**（尤其在数组最后一个元素后）、括号不匹配、引号使用了中文符号等。使用在线 JSON 校验工具进行检查。 |
| **下载速度缓慢** | 1. **服务器带宽瓶颈**：升级服务器带宽。2. **未使用 CDN**：这是根本性的解决方案，强烈建议采纳 **Part 1-方案C**。 |
| **出现 CORS 跨域错误** | 如果您的文件托管在与启动器API不同的域名上，可能出现此问题。需要在您的文件服务器（Nginx 或对象存储）上配置 CORS 策略，允许来自所有来源 (`*`) 的 GET 请求。 |
